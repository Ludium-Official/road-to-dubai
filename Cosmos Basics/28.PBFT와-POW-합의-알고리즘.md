# PBFT와 PoW 합의 알고리즘 

## 0. Safety와 Liveness 
분산 시스템에서 쓰이는 합의 알고리즘이 네트워크에서 일관성을 유지하며 통용되기 위해 필요한 속성을 Safety, Liveness라고 한다:
- Safety는 나쁜 일이 발생해서는 안되는 속성을 뜻한다. 합의된 결과는 모두에게 일관되게 보여져야 하고 변하지 않는다. 블록체인의 finality와 동일한 개념으로 봐도 된다.
- Liveness는 좋은 일이 발생해야만 하는 속성을 뜻한다. 블록체인 비동기 네트워크 내에서 반드시 합의가 이루어져야 한다.

### FLP Impossibility
그렇다면 Safety와 Liveness를 모두 충족하는 합의 알고리즘은 존재할 수 있을까? 1985년 'Impossibility of Distributed Consensus with One Faulty Process’ 논문에서 FLP Impossibility 결과를 도출해낸다. FLP는 논문 저자들의 앞글자를 따온 약자이다. 여기서 다룬 증명은 다음과 같이 귀류법을 통해 이뤄진다:
- 한 가지 결함이 있는 노드가 있는 경우에 Safety와 Liveness를 모두 만족하는 완전한 합의를 이룰 수 있다고 가정한 다음에 이에 대한 모순을 도출해낸다.
- 수신한 메시지에 따라 영구적으로 state를 전환하는 state machine이 있을 때, 메시지 수신 지연이 네트워크 지연에 의한 것인지 장애에 의한 것인지 알 수 없다. 그래서 계속 state를 변경하여 합의에 도달하지 못하는 상황이 발생하여 무한 실행이 이뤄진다.
- 그러므로, '한 가지 결함이 있는 노드가 있는 경우에 Safety와 Liveness를 모두 만족하는 완전한 합의를 이룰 수 있다'는 가정은 모순이 된다.
- 따라서, 비동기 네트워크에서는 Safety와 Liveness를 모두 만족하는 합의 알고리즘을 설계하는 것이 불가능함을 알 수 있다.

이러한 증명은 비동기 네트워크로 구성된 블록체인과 같은 분산 시스템 구조에서 합의 알고리즘을 설계하려면 Safety와 Liveness 사이에서 균형을 맞춰야 함을 의미한다. 이는 마치 두 가지 상반된 목표를 동시에 달성하려는 줄다리기와 같다. 이 균형을 잘 맞추는 것이 분산시스템 합의 알고리즘 핵심 과제 중 하나이다.

## 1. PBFT (Practical Byzantine Fault Tolerance)
1999년도에 제안된 PBFT 알고리즘은 비잔틴 장군 문제를 해결하여 BFT 알고리즘으로 실용적으로 고안해내었다. 비동기 네트워크간의 불확실한 커뮤니케이션 문제를 어느정도 해소하였고, 결정론적인 Saftey를 확보했다는 점에서 현재 많은 분산 시스템의 합의 방식으로 사용되고 있다. 본 논문에서는 뷰 변경 프로토콜, 3단계 프로토콜, 다수결 합의 시스템 등을 통해 어떻게 문제를 풀어나갔는지 설명한다. 
- Safety: 3단계 프로토콜(Pre-Prepare, Prepare, Commit)과 2/3 다수결 합의 시스템을 통해 최악의 비잔틴 상황에서도 올바른 합의에 도달할 수 있는 Safety를 보장한다.
- Liveness: 뷰 변경 프로토콜과 같은 기능으로 네트워크 지연과 노드의 장애에도 불구하고 합의를 이루고 정상적으로 동작함으로써 Liveness를 보장한다. 그러나 긴 지연이 발생하면 Liveness를 완전하게 보장한다고 할 수는 없어서 Liveness는 일부 희생한다고 보면 된다.

그러나 몇 단계 투표를 거쳐서 그만큼 높은 네트워크 통신을 요구한다는 단점이 있기 떄문에 노드가 추가될 수록 통신량이 급격히 증가하여 누구나 참여할 수 있는 블록체인에는 어울리지 않았다. 또한, 분산 시스템의 주류는 중앙화된 집단에 의해 운영되었기 때문에 다른 분야에서도 채택되어 사용되기에는 다소 무리가 있어서 실제 사용되는 사례는 드물었다. 


### 합의에 필요한 최소 노드 수: 3f+1 
최적은 복원력을 갖기 위해서 최소 3f+1개 노드가 있어야 비동기 시스템에서 safety와 liveness을 유지할 수 있다. f는 결함이 있는 복제본을 처리하는 데 필요한 최소 복제본 수이다. 이는 텐더민트 합의 최소 검증자 수에도 관통하는 내용이다. 비잔틴 상황에서 실패할 수 있는 경우는 두 가지이다:
1. $f_1$: 메시지를 보내지 않는 결함이 있는 노드
2. $f_2$: 악의적으로 잘못된 메시지를 보내는 비잔틴 노드

이 두 가지 경우($f_1$, $f_2$)를 모두 포함한 결함 노드를 $f$ 라고 하자. 전체의 노드 수가 $n$이라고 할때, 정상적인 합의를 위해 필요한 최소 노드 수를 계산해야 한다: 
- 정상 노드 수: $n - f$
- 정상 노드가 결함 노드보다 많아야 하므로 $n - f > f$, 즉 $n > 2f$ 이 되어야 한다. 
- 악의적 메시지를 보내는 노드 수보다 정상 노드 수가 많아야 하므로 $n - f > f$, 즉 $n > 3f$ 이 되어야 한다. 

따라서, 정상적인 합의를 위해서는 필요한 총 노드 수는 $n > 3f$이므로, 최소 $3f + 1$ 개의 노드가 필요하다. 이 경우 결함 노드의 최대 수는 $f$가 된다.

## 2. PoW (Proof of Work)
2008년 사토시 나카모토가 공개한 'Bitcoin: A Peer-to-Peer Electronic Cash System' 문서에는 재밌는 내용들이 담겨져 있다. 이 문서에는 P2P 기반 전자 화폐 시스템의 설계도가 담겨 있었으며, 나카모토가 제시한 합의 알고리즘은 기존 합의 알고리즘과는 다른 방식으로 Safety와 Liveness의 밸런스를 맞추었다.

기존의 중앙화된 시스템은 특정 목적을 달성하기 위해 자체적으로 구동되는 경우가 대부분이었기 때문에, 비동기 네트워크 환경에서 장애나 결함으로 인해 발생하는 생존성 문제만 고민하면 되었다. 그러나 비트코인의 등장으로 인해 이론적으로만 논의되던 비잔틴 장군 문제를 실제로 해결해야 하는 상황이 발생했다.

비트코인과 같은 탈중앙화된 분산 원장 시스템은 누구나 참여할 수 있지만, 동시에 누구나 참여하지 않을 수도 있으며, 참여자의 정직성을 보장할 방법도 고민해야 한다.
- (탈중앙성) 누구나 참여할 수 있지만 누구나 참여하지 않을 수 있다
- (고신뢰성) 누구나 참여할 수 있기 때문에 수 많은 참여자 중 악의적인 참여자를 식별하여 활동을 제한해야 한다.

비트코인은 BFT 합의 알고리즘을 전 세계적으로 구동시킨 최초의 분산 시스템이다. 이론적으로는 PBFT(Practical Byzantine Fault Tolerance)가 BFT 문제 해결을 먼저 제시했지만, 이를 실제로 작동하도록 구현한 것은 비트코인이 처음이었다.

### 인센티브 시스템
PoW 합의 알고리즘에서 인센티브 경제는 채굴자들이 지속적으로 네트워크에 참여하도록 유도하여 네트워크의 Liveness를 보장한다. 블록 보상과 거래 수수료는 채굴자들에게 중요한 경제적 동기를 제공하며, 이는 네트워크의 지속성과 안전성을 유지하는 데 핵심적인 역할을 한다. 
- 블록 보상: 채굴 연산을 통해 블록 생성을 하면 첫 거래에 비트코인 토큰을 얻는다.
- 거래 수수료: 블록에 담을 트랜잭션을 검증하고 그 트랜잭션에서 발생한 수수료를 얻는다.

### The Longest Chain
PoW는 기본적으로 CPU 당 1표의 투표권을 갖는다고 볼 수 있다. 합리적인 참여자들은 긴 체인에 투표를 할 것이다. 그래서 많은 PoW가 투입된 가장 긴 체인이 대표로 선정된다. 
- 이전 블록(과거 거래 정보)을 변경하기 위해서는 공격자는 그 블록과 뒤를 잇는 모든 블록의 작업증명을 재수행해야하고 그러면서 뒤를 잇는 모든 블록을 따라잡아 앞질러야 한다.
- 시간이 지날수록 노드를 구동하는 하드웨어 발전과 변화하는 관여도를 보상하기 위해, 작업 증명 난이도는 시간당 평균 블록 수에 따른 평균 목표치를 조정해 결정된다.블록이 너무 빠르게 생성된다면 난이도는 증가한다.

비트코인 네트워크는 모든 유효한 트랜잭션을 수락하고 가장 긴 블록(The Longest Chain)을 따라 포크를 해결함으로써 Liveness를 보장하고 있다. 
> 수많은 Fork 체인 속에서 Canonical 체인을 어떻게 확신할 수 있을까? 기회 비용으로 따지면 첫 번째가 가장 합리적인 이윤을 얻을 수 있다. 왜냐하면 PoW 합의를 이루기 위해서는 물리적인 리소스를 통해 연산을 해야 하기 때문이다. 여러 포크된 체인에 각각 블록을 생성하려는 시도는 긴 체인을 선택하는 것에 비해 기회 비용이 높을 수 밖에 없다. 따라서, 채굴자들은 자원의 효율적 사용을 위해 가장 긴 체인에 블록을 추가하는 전략을 선택하게 되며, 이는 네트워크 전체의 안정성과 무결성을 보장한다.

### 확률적인 Safety
기존 중앙화된 기관에 의해 분산 합의 시스템이 이뤄질 경우에는 비잔틴 환경을 고려하지 않아도 되었기 때문에 사실상 Liveness 보다는 Safety를 중요시 여겼다. 그러나 비트코인과 같이 중앙화된 집단없이도 전 세계적으로 멈추지 않는 시스템을 만들기 위해서 Safety를 확률적으로 희생하고 Liveness를 보장하는 방향을 발전했다. 그래서 PoW는 결정적이 아닌 확률적인 Safey를 보장하게 된다. 

### PoW 단점 1: 51% 공격
Safety를 확률적으로 확보하면서 51% 공격과 같은 네트워크 공격이 성공할 경우 Safety를 보장할 수 없다는 단점을 안고 있다. 

만약 51%, 49% 시나리오가 장기적으로 지속되면 어떻게 할까? 일반적인 시나리오에서는 거의 발생하지 않는다.(가장 큰 규모로는 ethereum epoch 121471에서 7개의 블록이 re-org 발생한 적이 있다) 혹 고의적으로 기존 네트워크에 침투하는 세력이 있는 경우에는 엄청난 해시력이 필요하기 때문에 긴 fork 상황이 지속될수록 불안정한 상태로 머물게된다. 그리고 51% 공격을 계속 한다고 해도 어떠한 체계, 가치를 무너뜨리는 동기가 없는 한 결국 공격자가 경제적으로 손실을 보게 된다. 가장 높은 연산력(51%)을 보유하게 되면 가장 많은 블록을 생성하게 되고 블록의 신뢰성이 무너지게 됨에 따라 손해가 보는 쪽은 높은 연산력을 가지고 있는 쪽이기 때문이다. 

### PoW 단점 2: 과도한 에너지 낭비
그러나 잘 동작하기는 하였으나 PoW 자체의 문제는 존재했다. CPU당 1표라는 투표권을 지니는 해당 분산 합의 매커니즘은 엄청난 에너지 소모를 야기했고 혼잡 네트워크와 함께 수수료 급등 문제가 발생하여 확장성에 문제점을 안게 되었다. 

## Next: 텐더민트와 PoS
과도한 에너지 낭비가 주된 문제로 뽑히기 시작하였고 그렇게 다음 세대의 합의 알고리즘이 등장하기 시작하였다. 바로 지분 증명이라고 불리우는 Proof of Stake(PoS)이다. PoS을 구현하는 방법은 다양하지만, PoS 디자인의 두 가지 주요 원칙은 chain 기반 PoS와 BFT 기반 PoS이다.
- Tendermint(Jae kwon)는 BFT 기반 지분 증명 설계이다. 
- Casper the Friendly Ghost(Vlad, Vitalik)는 Chain 기반 지분 증명 설계이다.
- Casper the Friendly Finality Gadget(Vlad)은 이 두 가지를 혼합한 하이브리드이다.

Chain 기반은 비트코인의 탈중앙화 이념을 이어나간 PoS 개념으로 보면 되고, BFT 기반은 컴퓨터 과학 이론적인 토대에서 나아간 PoS 개념이라고 보면 된다. 그래서 Chain 기반은 Liveness에 더 중점을 두고 있고, BFT 기반은 Safety에 더 중점을 두고 있다. 
- Chain 기반인 이더리움은 확률적인 Safety 문제로 체인이 포크되는 현상을 가지고 있다. 그러다보니 지분 증명에서만 발생하는 "nothing at stake"라는 문제가 발생하였는데 이를 staking period와 slashing와 같은 개념을 도입하여 문제를 해결한다. 
- BFT 기반인 텐더민트는 결정적인 Safety(즉, 즉각적인 Finality)를 가지고 있어서 체인이 포크되는 현상은 발생하지 않는다. 그러나 이는 악의적인 행동이 발생하게 되면 Liveness에 크게 영향을 주게 된다. 그래서 마찬가지로 staking period와 slashing 같은 개념을 통해 문제를 해결한다. 

우리가 앞으로 알아 볼 내용은 BFT 기반인 텐더민트 합의 알고리즘이다. 아티클은 대표적인 BFT 합의 알고리즘의 기본에 해당하는 PBFT와 연관지어 설명하는 아티클과 새롭게 퍼블릭 블록체인에 맞게 탄생한 PoS 합의 알고리즘에 연관지어 설명하는 아티클로 구성된다: 
1. [tendermint_with_bft](./99c1_tendermint_with_bft.md)
2. [tendermint_with_pos](./99c2_tendermint_with_pos.md)

## Resources
- CASTRO, M.AND LISKOV, B. Practical Byzantine Fault Tolerance. In Proceedings of the Third Symposium on Operating Systems Design and Implementation (OSDI), USENIX, New Orleans, 1999b.
- Impossibility of Distributed Consensus with One Faulty Process, Michael J. Fischer, Nancy A. Lynch, Michael S. Paterson 
- Satoshi Nakamoto, Bitcoin: A Peer-to-Peer Electronic Cash System, Oct 2008
- Ethan Buchman, "Tendermint: Byzantine Fault Tolerance in the Age of Blockchains", Juen. 2016, https://atrium.lib.uoguelph.ca/items/5459099e-67aa-4a23-83ae-d3471d8d8336